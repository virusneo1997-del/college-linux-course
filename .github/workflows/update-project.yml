name: Update Project (User-level)

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, review_requested, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Move PR in User Project
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN_FINE }}
        script: |
          const projectOwner = "virusneo1997-del";  // user login
          const projectNumber = 1;                  // номер USER-проекта
          
          // 1. Получить проект пользователя
          const user = await github.graphql(`
            query($projectOwner: String!, $projectNumber: Int!) {
              user(login: $projectOwner) {
                projectV2(number: $projectNumber) {
                  id
                  fields(first: 20) {
                    nodes {
                      id
                      name
                      dataType
                      ... on ProjectV2SingleSelectField {
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          `, {
            projectOwner,
            projectNumber
          });

          const project = user.user.projectV2;

          if (!project) {
            core.setFailed("❌ User-level Project not found! Проверь номер проекта.");
            return;
          }

          const statusField = project.fields.nodes.find(f => f.name === "Status");

          // Опции статусов
          const toDo = statusField.options.find(o => o.name === "To do")?.id;
          const inProgress = statusField.options.find(o => o.name === "In progress")?.id;
          const inReview = statusField.options.find(o => o.name === "In review")?.id;
          const done = statusField.options.find(o => o.name === "Done")?.id;

          // 2. Ищем task в проекте по номеру PR
          const itemSearch = await github.graphql(`
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  items(first: 50) {
                    nodes {
                      id
                      content {
                        ... on PullRequest { number }
                      }
                    }
                  }
                }
              }
            }
          `, {
            projectId: project.id
          });

          const items = itemSearch.node.items.nodes;
          const prNumber = context.payload.pull_request.number;

          // Ищем item в проекте
          let item = items.find(i => i.content?.number === prNumber);

          // Если нет — создаём
          if (!item) {
            const newItem = await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId,
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `, {
              projectId: project.id,
              contentId: context.payload.pull_request.node_id
            });

            item = { id: newItem.addProjectV2ItemById.item.id };
          }

          // 3. Определяем новый статус
          let newStatus = null;

          if (context.payload.action === "opened") {
            newStatus = inProgress;
          }

          if (context.payload.pull_request.requested_reviewers?.length > 0) {
            newStatus = inReview;
          }

          if (context.payload.pull_request.merged) {
            newStatus = done;
          }

          if (context.payload.action === "closed" && !context.payload.pull_request.merged) {
            newStatus = toDo;
          }

          if (!newStatus) {
            console.log("⚠ Нет изменения статуса, пропускаем.");
            return;
          }

          // 4. Обновляем статус
          await github.graphql(`
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId,
                itemId: $itemId,
                fieldId: $fieldId,
                value: { singleSelectOptionId: $value }
              }) {
                projectV2Item {
                  id
                }
              }
            }
          `, {
            projectId: project.id,
            itemId: item.id,
            fieldId: statusField.id,
            value: newStatus
          });

          console.log("✅ Project updated successfully!");
