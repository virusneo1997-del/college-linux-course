name: update-project

on:
  pull_request:
    types: [opened, edited, synchronize, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          echo "REPO_OWNER=virusneo1997-del" >> $GITHUB_ENV
          echo "REPO_NAME=college-linux-course" >> $GITHUB_ENV
          echo "PROJECT_NUMBER=2" >> $GITHUB_ENV

      - name: Find Project ID
        id: find_project
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query {
              user(login: "virusneo1997-del") {
                projectV2(number: 2) {
                  id
                }
              }
            }' --jq '.data.user.projectV2.id')

          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      - name: Add PR to Project v2 (if missing)
        id: add_pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($project: ID!, $pr: Int!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      content {
                        ... on PullRequest { number }
                      }
                    }
                  }
                }
              }
            }' -f project=$PROJECT_ID -f pr=${{ github.event.pull_request.number }} --jq '.data.node.items.nodes[] | select(.content.number == ${{ github.event.pull_request.number }})')

          if [ -z "$ITEM_ID" ]; then
            ITEM_ID=$(gh api graphql -f query='
              mutation($project: ID!, $content: ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $content}) {
                  item {
                    id
                  }
                }
              }' -f project=$PROJECT_ID -f content=${{ github.event.pull_request.node_id }} --jq '.data.addProjectV2ItemById.item.id')
          fi

          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_ENV

      - name: Get column IDs
        id: get_columns
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          COLUMNS=$(gh api graphql -f query='
            query($project: ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            }' -f project=$PROJECT_ID)

          TODO=$(echo "$COLUMNS" | jq -r '.data.node.fields.nodes[] | select(.name == "Todo") | .id')
          INPROGRESS=$(echo "$COLUMNS" | jq -r '.data.node.fields.nodes[] | select(.name == "In Progress") | .id')
          INREVIEW=$(echo "$COLUMNS" | jq -r '.data.node.fields.nodes[] | select(.name == "In Review") | .id')
          DONE=$(echo "$COLUMNS" | jq -r '.data.node.fields.nodes[] | select(.name == "Done") | .id')

          echo "TODO=$TODO" >> $GITHUB_ENV
          echo "INPROGRESS=$INPROGRESS" >> $GITHUB_ENV
          echo "INREVIEW=$INREVIEW" >> $GITHUB_ENV
          echo "DONE=$DONE" >> $GITHUB_ENV

      - name: Determine new status
        id: determine
        run: |
          STATUS=""

          if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            STATUS=$DONE
          elif [[ "${{ github.event.action }}" == "closed" ]]; then
            STATUS=$TODO
          elif [[ -n "${{ github.event.pull_request.requested_reviewers }}" ]]; then
            STATUS=$INREVIEW
          else
            STATUS=$INPROGRESS
          fi

          echo "STATUS=$STATUS" >> $GITHUB_ENV

      - name: Update status in Project v2
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          gh api graphql -f query='
            mutation($item: ID!, $field: ID!, $value: String!) {
              updateProjectV2ItemFieldValue(input: {
                itemId: $item,
                fieldId: $field,
                value: {singleSelectOptionId: $value}
              }) {
                clientMutationId
              }
            }' \
            -f item=$ITEM_ID \
            -f field=$INPROGRESS \
            -f value=$STATUS
