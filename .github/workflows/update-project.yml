name: Update Project (User-level)

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, review_requested, closed]

jobs:
  update-project:
   name: Update Project Status

on:
  pull_request:
    types: [opened, reopened, synchronize, closed, review_requested]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Update Personal Project Board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const projectId = "PVT_kwHODlAJvM4BHrKr"; 
            const fieldName = "–°—Ç–∞—Ç—É—Å";
            const pr = context.payload.pull_request;
            
            if (!pr) {
              console.log("‚ùå –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å pull request.");
              return;
            }

            console.log(`üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º PR: #${pr.number} - ${pr.title}`);
            console.log(`üîÑ –î–µ–π—Å—Ç–≤–∏–µ: ${context.payload.action}, –û–±—ä–µ–¥–∏–Ω–µ–Ω: ${pr.merged}`);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            let fieldValue = null;
            const action = context.payload.action;
            const merged = pr.merged;
            const hasReviewers = pr.requested_reviewers?.length > 0;

            if (action === "opened" || action === "reopened" || action === "synchronize") {
              fieldValue = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";
            } else if (action === "review_requested" || hasReviewers) {
              fieldValue = "–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏";
            } else if (action === "closed" && merged) {
              fieldValue = "–ì–æ—Ç–æ–≤–æ";
            } else if (action === "closed" && !merged) {
              fieldValue = "–í —Ä–∞–±–æ—Ç–µ";
            }

            if (!fieldValue) {
              console.log("‚ÑπÔ∏è –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º ‚Äî —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞.");
              return;
            }

            console.log(`üìå –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${fieldValue}`);

            try {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–µ–∫—Ç—É
              console.log("üîç –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ...");
              const projectQuery = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectResult = await github.graphql(projectQuery, { projectId });
              
              if (!projectResult.node) {
                throw new Error(`–ü—Ä–æ–µ–∫—Ç —Å ID ${projectId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
              }

              console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${projectResult.node.title}`);

              const fields = projectResult.node.fields.nodes;
              console.log("üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:", fields.map(f => f.name).join(', '));

              const statusField = fields.find(f => f.name === fieldName);
              
              if (!statusField) {
                const availableFields = fields.map(f => f.name).join(', ');
                console.log(`‚ùå –ü–æ–ª–µ "${fieldName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ`);
                console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è: ${availableFields}`);
                throw new Error(`–ü–æ–ª–µ "${fieldName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ`);
              }

              console.log(`‚úÖ –ü–æ–ª–µ "${fieldName}" –Ω–∞–π–¥–µ–Ω–æ, ID: ${statusField.id}`);

              const statusOption = statusField.options.find(o => o.name === fieldValue);
              if (!statusOption) {
                const availableOptions = statusField.options.map(o => o.name).join(', ');
                console.log(`‚ùå –û–ø—Ü–∏—è "${fieldValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏: ${availableOptions}`);
                throw new Error(`–û–ø—Ü–∏—è "${fieldValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
              }

              console.log(`‚úÖ –û–ø—Ü–∏—è "${fieldValue}" –Ω–∞–π–¥–µ–Ω–∞, ID: ${statusOption.id}`);

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç—Ç–æ—Ç PR –≤ –ø—Ä–æ–µ–∫—Ç–µ
              console.log("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ PR —É–∂–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ...");
              const checkItemQuery = `
                query ($projectId: ID!, $prNodeId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 50) {
                        nodes {
                          id
                          content {
                            ... on PullRequest {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const existingItems = await github.graphql(checkItemQuery, {
                projectId,
                prNodeId: pr.node_id
              });

              const existingItem = existingItems.node.items.nodes.find(
                item => item.content?.id === pr.node_id
              );

              let itemId;

              if (existingItem) {
                itemId = existingItem.id;
                console.log(`‚úÖ PR —É–∂–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ, ID —ç–ª–µ–º–µ–Ω—Ç–∞: ${itemId}`);
              } else {
                // –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
                console.log(`‚ûï –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç...`);
                try {
                  const addItemResult = await github.graphql(`
                    mutation($projectId: ID!, $contentId: ID!) {
                      addProjectV2ItemById(input: {
                        projectId: $projectId,
                        contentId: $contentId
                      }) {
                        item { id }
                      }
                    }
                  `, {
                    projectId,
                    contentId: pr.node_id
                  });

                  itemId = addItemResult.addProjectV2ItemById.item.id;
                  console.log(`‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç, ID —ç–ª–µ–º–µ–Ω—Ç–∞: ${itemId}`);
                } catch (addError) {
                  console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ PR –≤ –ø—Ä–æ–µ–∫—Ç:", addError.message);
                  // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - –≤–æ–∑–º–æ–∂–Ω–æ —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω
                  if (addError.message.includes("already exists")) {
                    console.log("‚ÑπÔ∏è PR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...");
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç —Å–Ω–æ–≤–∞
                    const retryItems = await github.graphql(checkItemQuery, {
                      projectId,
                      prNodeId: pr.node_id
                    });
                    const retryItem = retryItems.node.items.nodes.find(
                      item => item.content?.id === pr.node_id
                    );
                    if (retryItem) {
                      itemId = retryItem.id;
                    } else {
                      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –Ω–∞–π—Ç–∏ PR –≤ –ø—Ä–æ–µ–∫—Ç–µ");
                    }
                  } else {
                    throw addError;
                  }
                }
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              console.log("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å...");
              await github.graphql(`
                mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: statusField.id,
                optionId: statusOption.id
              });

              console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚Üí "${fieldValue}"`);

            } catch (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞:", error.message);
              
              // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∂–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
              if (error.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")) {
                console.log("üîÑ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤...");
                try {
                  const projectsQuery = `
                    query($user: String!) {
                      user(login: $user) {
                        projectsV2(first: 10) {
                          nodes {
                            id
                            title
                            number
                          }
                        }
                      }
                    }
                  `;
                  
                  const projectsResult = await github.graphql(projectsQuery, {
                    user: context.repo.owner
                  });
                  
                  console.log("=== –í–ê–®–ò –ü–†–û–ï–ö–¢–´ ===");
                  projectsResult.user.projectsV2.nodes.forEach(project => {
                    console.log(`üìÅ –ù–∞–∑–≤–∞–Ω–∏–µ: ${project.title}`);
                    console.log(`   ID: ${project.id}`);
                    console.log(`   –ù–æ–º–µ—Ä: ${project.number}`);
                    console.log('---');
                  });
                } catch (debugError) {
                  console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤:", debugError.message);
                }
              } else if (error.message.includes("Resource not accessible")) {
                console.log("üîê –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:");
                console.log("- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å PERSONAL_ACCESS_TOKEN");
                console.log("- –ü—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞ (repo, project, write:project)");
                console.log("- –ß—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω");
              }
            }