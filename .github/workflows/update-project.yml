name: Update Project (User-level)

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, review_requested, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
      
      - name: Install GitHub CLI
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Move PR in User Project
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "üîç –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub CLI –¥–ª—è GraphQL –∑–∞–ø—Ä–æ—Å–∞
          PROJECT_OWNER="virusneo1997-del"
          PROJECT_NUMBER=1

          # 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
          echo "üìã –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ..."
          PROJECT_QUERY='
          query($owner: String!, $number: Int!) {
            user(login: $owner) {
              projectV2(number: $number) {
                id
                title
                fields(first: 20) {
                  nodes {
                    ... on ProjectV2Field {
                      id
                      name
                    }
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          }
          '

          PROJECT_RESULT=$(gh api graphql -f query="$PROJECT_QUERY" -f owner="$PROJECT_OWNER" -f number="$PROJECT_NUMBER" || echo "ERROR")

          if [ "$PROJECT_RESULT" = "ERROR" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
            echo "- PROJECT_OWNER: $PROJECT_OWNER"
            echo "- PROJECT_NUMBER: $PROJECT_NUMBER" 
            echo "- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å PERSONAL_ACCESS_TOKEN"
            exit 1
          fi

          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ JSON –æ—Ç–≤–µ—Ç–∞
          PROJECT_ID=$(echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.id // empty')
          
          if [ -z "$PROJECT_ID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø—Ä–æ–µ–∫—Ç–∞"
            echo "–û—Ç–≤–µ—Ç API:"
            echo "$PROJECT_RESULT"
            exit 1
          fi

          echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –Ω–∞–π–¥–µ–Ω, ID: $PROJECT_ID"

          # 2. –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
          echo "‚ûï –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç..."
          PR_NODE_ID="${{ github.event.pull_request.node_id }}"

          ADD_ITEM_MUTATION='
          mutation($projectId: ID!, $contentId: ID!) {
            addProjectV2ItemById(input: {
              projectId: $projectId,
              contentId: $contentId
            }) {
              item {
                id
              }
            }
          }
          '

          ADD_RESULT=$(gh api graphql -f query="$ADD_ITEM_MUTATION" -f projectId="$PROJECT_ID" -f contentId="$PR_NODE_ID" || echo "ERROR")

          if [ "$ADD_RESULT" = "ERROR" ]; then
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å PR –≤ –ø—Ä–æ–µ–∫—Ç (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)"
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - –≤–æ–∑–º–æ–∂–Ω–æ —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          else
            ITEM_ID=$(echo "$ADD_RESULT" | jq -r '.data.addProjectV2ItemById.item.id // empty')
            if [ -n "$ITEM_ID" ]; then
              echo "‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç, ID —ç–ª–µ–º–µ–Ω—Ç–∞: $ITEM_ID"
            fi
          fi

          # 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üîÑ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å..."
          ACTION="${{ github.event.action }}"
          MERGED="${{ github.event.pull_request.merged }}"
          HAS_REVIEWERS="${{ github.event.pull_request.requested_reviewers }}"

          STATUS_FIELD_ID=$(echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .id // empty')
          
          if [ -z "$STATUS_FIELD_ID" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ 'Status' –≤ –ø—Ä–æ–µ–∫—Ç–µ"
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:"
            echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[].name'
            exit 1
          fi

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
          if [ "$ACTION" = "opened" ] || [ "$ACTION" = "reopened" ]; then
            OPTION_ID=$(echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In Progress" or .name == "In progress") | .id // empty')
            STATUS_NAME="In Progress"
          elif [ "$ACTION" = "ready_for_review" ] || [ -n "$HAS_REVIEWERS" ]; then
            OPTION_ID=$(echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In Review" or .name == "In review") | .id // empty')
            STATUS_NAME="In Review"
          elif [ "$MERGED" = "true" ]; then
            OPTION_ID=$(echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "Done") | .id // empty')
            STATUS_NAME="Done"
          elif [ "$ACTION" = "closed" ] && [ "$MERGED" = "false" ]; then
            OPTION_ID=$(echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "To Do" or .name == "To do") | .id // empty')
            STATUS_NAME="To Do"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
            exit 0
          fi

          if [ -z "$OPTION_ID" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ '$STATUS_NAME'"
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏:"
            echo "$PROJECT_RESULT" | jq -r '.data.user.projectV2.fields.nodes[] | select(.name == "Status") | .options[].name'
            exit 1
          fi

          echo "üìå –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å: $STATUS_NAME"

          # –ï—Å–ª–∏ ITEM_ID –Ω–µ –ø–æ–ª—É—á–µ–Ω –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏, –∏—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
          if [ -z "$ITEM_ID" ]; then
            echo "üîç –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç PR –≤ –ø—Ä–æ–µ–∫—Ç–µ..."
            FIND_ITEM_QUERY='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  items(first: 50) {
                    nodes {
                      id
                      content {
                        ... on PullRequest {
                          number
                        }
                      }
                    }
                  }
                }
              }
            }
            '

            ITEMS_RESULT=$(gh api graphql -f query="$FIND_ITEM_QUERY" -f projectId="$PROJECT_ID")
            PR_NUMBER="${{ github.event.pull_request.number }}"
            
            ITEM_ID=$(echo "$ITEMS_RESULT" | jq -r ".data.node.items.nodes[] | select(.content.number == $PR_NUMBER) | .id // empty")
            
            if [ -z "$ITEM_ID" ]; then
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ PR –≤ –ø—Ä–æ–µ–∫—Ç–µ"
              exit 1
            fi
            echo "‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç, ID: $ITEM_ID"
          fi

          # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          UPDATE_MUTATION='
          mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $projectId,
              itemId: $itemId,
              fieldId: $fieldId,
              value: { singleSelectOptionId: $optionId }
            }) {
              projectV2Item {
                id
              }
            }
          }
          '

          UPDATE_RESULT=$(gh api graphql -f query="$UPDATE_MUTATION" \
            -f projectId="$PROJECT_ID" \
            -f itemId="$ITEM_ID" \
            -f fieldId="$STATUS_FIELD_ID" \
            -f optionId="$OPTION_ID")

          if [ $? -eq 0 ]; then
            echo "‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '$STATUS_NAME'!"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞"
            exit 1
          fi