name: Update Project (User-level)

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review, review_requested, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Update Project with GitHub Script
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const projectOwner = "virusneo1997-del";
            const projectNumber = 1;
            
            console.log("üîç –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...");
            console.log(`üìù PR –¥–µ–π—Å—Ç–≤–∏–µ: ${context.payload.action}`);
            console.log(`üî¢ –ù–æ–º–µ—Ä PR: ${context.payload.pull_request.number}`);

            try {
              // 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
              console.log("üìã –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ...");
              const projectQuery = `
                query($owner: String!, $number: Int!) {
                  user(login: $owner) {
                    projectV2(number: $number) {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectResult = await github.graphql(projectQuery, {
                owner: projectOwner,
                number: projectNumber
              });

              const project = projectResult.user.projectV2;

              if (!project) {
                throw new Error(`–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. Owner: ${projectOwner}, Number: ${projectNumber}`);
              }

              console.log(`‚úÖ –ü—Ä–æ–µ–∫—Ç –Ω–∞–π–¥–µ–Ω: ${project.title}`);
              console.log(`üÜî ID –ø—Ä–æ–µ–∫—Ç–∞: ${project.id}`);

              const projectId = project.id;

              // 2. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ Status
              const statusField = project.fields.nodes.find(f => f.name === "Status");
              
              if (!statusField) {
                const availableFields = project.fields.nodes.map(f => f.name).join(', ');
                throw new Error(`–ü–æ–ª–µ 'Status' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è: ${availableFields}`);
              }

              console.log(`‚úÖ –ü–æ–ª–µ 'Status' –Ω–∞–π–¥–µ–Ω–æ, ID: ${statusField.id}`);

              // 3. –ù–∞—Ö–æ–¥–∏–º –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
              const statusOptions = {
                todo: statusField.options.find(o => o.name === "To Do" || o.name === "To do")?.id,
                inProgress: statusField.options.find(o => o.name === "In Progress" || o.name === "In progress")?.id,
                inReview: statusField.options.find(o => o.name === "In Review" || o.name === "In review")?.id,
                done: statusField.options.find(o => o.name === "Done")?.id
              };

              console.log("üìä –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:", statusOptions);

              // 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
              const action = context.payload.action;
              const isMerged = context.payload.pull_request.merged;
              const hasReviewers = context.payload.pull_request.requested_reviewers?.length > 0;
              const prNodeId = context.payload.pull_request.node_id;
              const prNumber = context.payload.pull_request.number;

              let newStatusId = null;
              let statusName = "";

              if (action === "opened" || action === "reopened") {
                newStatusId = statusOptions.inProgress;
                statusName = "In Progress";
              } else if (action === "ready_for_review" || hasReviewers) {
                newStatusId = statusOptions.inReview;
                statusName = "In Review";
              } else if (isMerged) {
                newStatusId = statusOptions.done;
                statusName = "Done";
              } else if (action === "closed" && !isMerged) {
                newStatusId = statusOptions.todo;
                statusName = "To Do";
              }

              if (!newStatusId) {
                console.log("‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
                return;
              }

              console.log(`üìå –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å: ${statusName}`);

              // 5. –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç PR –≤ –ø—Ä–æ–µ–∫—Ç–µ
              console.log("üîç –ò—â–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç–µ...");
              const findItemQuery = `
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 50) {
                        nodes {
                          id
                          content {
                            ... on PullRequest {
                              id
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const itemsResult = await github.graphql(findItemQuery, { projectId });
              const items = itemsResult.node.items.nodes;
              
              const existingItem = items.find(item => 
                item.content?.number === prNumber || item.content?.id === prNodeId
              );

              let itemId;

              if (existingItem) {
                itemId = existingItem.id;
                console.log(`‚úÖ PR —É–∂–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ, ID —ç–ª–µ–º–µ–Ω—Ç–∞: ${itemId}`);
              } else {
                // 6. –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
                console.log("‚ûï –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç...");
                try {
                  const addItemResult = await github.graphql(`
                    mutation($projectId: ID!, $contentId: ID!) {
                      addProjectV2ItemById(input: {
                        projectId: $projectId,
                        contentId: $contentId
                      }) {
                        item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId,
                    contentId: prNodeId
                  });

                  itemId = addItemResult.addProjectV2ItemById.item.id;
                  console.log(`‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç, ID —ç–ª–µ–º–µ–Ω—Ç–∞: ${itemId}`);
                } catch (addError) {
                  if (addError.message.includes("already exists")) {
                    console.log("‚ÑπÔ∏è PR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ, –∏—â–µ–º —Å–Ω–æ–≤–∞...");
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç —Å–Ω–æ–≤–∞
                    const retryItems = await github.graphql(findItemQuery, { projectId });
                    const retryItem = retryItems.node.items.nodes.find(item => 
                      item.content?.number === prNumber || item.content?.id === prNodeId
                    );
                    if (retryItem) {
                      itemId = retryItem.id;
                      console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç, ID: ${itemId}`);
                    } else {
                      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –Ω–∞–π—Ç–∏ PR –≤ –ø—Ä–æ–µ–∫—Ç–µ");
                    }
                  } else {
                    throw addError;
                  }
                }
              }

              // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              console.log("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å...");
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $value }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: statusField.id,
                value: newStatusId
              });

              console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '${statusName}'!`);

            } catch (error) {
              console.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error.message);
              
              if (error.message.includes("NOT_FOUND")) {
                console.log("üîç –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å:");
                console.log("- –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ–µ–∫—Ç —Å –Ω–æ–º–µ—Ä–æ–º", projectNumber);
                console.log("- –î–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –æ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", projectOwner);
              } else if (error.message.includes("Resource not accessible")) {
                console.log("üîê –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:");
                console.log("- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å PERSONAL_ACCESS_TOKEN");
                console.log("- –ü—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞ (repo, project, write:project)");
              }
              
              // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã workflow –Ω–µ –ø–∞–¥–∞–ª
              console.log("‚ö†Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö workflow...");
            }