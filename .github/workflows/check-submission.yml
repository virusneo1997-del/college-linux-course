name: Check Student Submission

on:
  pull_request:
    paths:
      - 'lessons/**'
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate-submission:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Debug - Show repository structure
        run: |
          echo "=== –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ==="
          find . -maxdepth 3 -type d -name "[0-9]*" | sort || echo "–ü–∞–ø–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ lessons ==="
          ls -la lessons/ || echo "–ü–∞–ø–∫–∞ lessons –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          
      - name: Find lesson folders
        id: find-lessons
        run: |
          echo "üîç –ò—â–µ–º –ø–∞–ø–∫–∏ —É—Ä–æ–∫–æ–≤ –≤ lessons/..."
          
          if [ ! -d "lessons" ]; then
            echo "‚ùå –ü–∞–ø–∫–∞ lessons –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "lesson_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # –ò—â–µ–º –ø–∞–ø–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ (01-, 02-, –∏ —Ç.–¥.)
          lesson_folders=$(find lessons -maxdepth 1 -type d -name "[0-9]*-*" | sort)
          
          if [ -z "$lesson_folders" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–∞–ø–∫–∏ —É—Ä–æ–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 01-name, 02-name –∏ —Ç.–¥."
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–ø–∫–∏ –≤ lessons/:"
            ls -la lessons/
            echo "lesson_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã –ø–∞–ø–∫–∏ —É—Ä–æ–∫–æ–≤:"
          echo "$lesson_folders"
          
          # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          first_lesson=$(echo "$lesson_folders" | head -1)
          lesson_name=$(basename "$first_lesson")
          
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É: $lesson_name"
          echo "lesson_name=$lesson_name" >> $GITHUB_OUTPUT
          echo "lesson_path=$first_lesson" >> $GITHUB_OUTPUT
          echo "lesson_found=true" >> $GITHUB_OUTPUT
          
      - name: Validate lesson structure
        if: steps.find-lessons.outputs.lesson_found == 'true'
        run: |
          lesson_name="${{ steps.find-lessons.outputs.lesson_name }}"
          lesson_path="${{ steps.find-lessons.outputs.lesson_path }}"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —É—Ä–æ–∫–∞: $lesson_name"
          echo "üìÅ –ü—É—Ç—å: $lesson_path"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ —É—Ä–æ–∫–∞
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ $lesson_name ==="
          ls -la "$lesson_path/" || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ student-report.md
          if [ ! -f "$lesson_path/student-report.md" ]; then
            echo "::error ::–í –ø–∞–ø–∫–µ —É—Ä–æ–∫–∞ $lesson_name –Ω–µ—Ç —Ñ–∞–π–ª–∞ student-report.md"
            echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª student-report.md –≤ –ø–∞–ø–∫–µ $lesson_path/"
            exit 1
          fi
          
          echo "‚úÖ –§–∞–π–ª student-report.md –Ω–∞–π–¥–µ–Ω"
          
      - name: Validate student-report.md content
        if: steps.find-lessons.outputs.lesson_found == 'true'
        run: |
          lesson_path="${{ steps.find-lessons.outputs.lesson_path }}"
          report_file="$lesson_path/student-report.md"
          
          echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ student-report.md..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -s "$report_file" ]; then
            echo "::error ::–§–∞–π–ª student-report.md –ø—É—Å—Ç–æ–π"
            echo "–î–æ–±–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª $report_file"
            exit 1
          fi
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞
          echo "=== –ù–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ student-report.md ==="
          head -10 "$report_file" || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª"
          echo "====================================="
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
          file_size=$(wc -c < "$report_file")
          echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $file_size –±–∞–π—Ç"
          
          if [ "$file_size" -lt 50 ]; then
            echo "::warning ::–§–∞–π–ª student-report.md –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π (–º–µ–Ω—å—à–µ 50 –±–∞–π—Ç)"
            echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
          if ! grep -qi -E "–æ—Ç–≤–µ—Ç|solution|—Ä–µ—à–µ–Ω–∏–µ|–æ—Ç—á–µ—Ç|report|–∑–∞–¥–∞–Ω–∏–µ|task|–≤—ã–ø–æ–ª–Ω–∏–ª|—Å–¥–µ–ª–∞–ª" "$report_file"; then
            echo "::warning ::–í —Ñ–∞–π–ª–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–æ—Ç–≤–µ—Ç, —Ä–µ—à–µ–Ω–∏–µ, –æ—Ç—á–µ—Ç –∏ —Ç.–¥.)"
            echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è"
          else
            echo "‚úÖ –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–¥–∞–Ω–∏—è"
          fi
          
      - name: Run basic tests
        if: steps.find-lessons.outputs.lesson_found == 'true'
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏..."
          lesson_path="${{ steps.find-lessons.outputs.lesson_path }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ —É—Ä–æ–∫–∞
          binary_files=$(find "$lesson_path" -type f -exec file {} \; | grep -i "executable\|binary" | head -5 || true)
          
          if [ -n "$binary_files" ]; then
            echo "::warning ::–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ —É—Ä–æ–∫–∞:"
            echo "$binary_files"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ —É—Ä–æ–∫–∞
          lesson_size=$(du -sh "$lesson_path" | cut -f1)
          echo "üìÅ –†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ —É—Ä–æ–∫–∞: $lesson_size"
          
          if [ "$lesson_size" = "0" ] || [ "$lesson_size" = "4,0K" ]; then
            echo "::warning ::–ü–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∞—è, –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –≤—Å–µ —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã"
          fi
          
      - name: Setup Python environment
        if: steps.find-lessons.outputs.lesson_found == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        if: steps.find-lessons.outputs.lesson_found == 'true'
        run: |
          python -m pip install --upgrade pip
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
          pip install pytest || echo "Pytest –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          
      - name: Run validation tests
        if: steps.find-lessons.outputs.lesson_found == 'true'
        run: |
          echo "üéØ –ó–∞–ø—É—Å–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
          lesson_name="${{ steps.find-lessons.outputs.lesson_name }}"
          
          # –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è student-report.md... ‚úÖ"
          echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π... ‚úÖ"
          echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–∫–∏... ‚úÖ"
          
          # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —É—Ä–æ–∫–∞
          if [ -f "tests/test_$lesson_name.py" ]; then
            echo "üîç –ù–∞–π–¥–µ–Ω —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è —É—Ä–æ–∫–∞ $lesson_name"
            pytest "tests/test_$lesson_name.py" -v
          else
            echo "‚ÑπÔ∏è –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —É—Ä–æ–∫–∞ $lesson_name –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          fi
          
      - name: Success validation
        if: steps.find-lessons.outputs.lesson_found == 'true' && success()
        run: |
          lesson_name="${{ steps.find-lessons.outputs.lesson_name }}"
          echo "üéâ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–∫–∞ $lesson_name –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
          echo "‚úÖ –§–∞–π–ª student-report.md –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π"
          echo "‚úÖ –í—Å–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"
          
      - name: Failure validation
        if: failure()
        run: |
          echo "‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
          echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –æ–±–Ω–æ–≤–∏—Ç–µ PR"
          echo "–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:"
          echo "- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 01-name, 02-name –∏ —Ç.–¥."
          echo "- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª student-report.md –≤ –ø–∞–ø–∫–µ —É—Ä–æ–∫–∞"
          echo "- –§–∞–π–ª student-report.md –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π"
          
      - name: Skip validation - no lessons found
        if: steps.find-lessons.outputs.lesson_found == 'false'
        run: |
          echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ - –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–∞–ø–∫–∏ —É—Ä–æ–∫–æ–≤"
          echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:"
          echo "1. –ü–∞–ø–∫–∞ lessons —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          echo "2. –í –ø–∞–ø–∫–µ lessons –µ—Å—Ç—å –ø–∞–ø–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 01-name, 02-name –∏ —Ç.–¥."
          echo "3. –í –ø–∞–ø–∫–µ —É—Ä–æ–∫–∞ –µ—Å—Ç—å —Ñ–∞–π–ª student-report.md"