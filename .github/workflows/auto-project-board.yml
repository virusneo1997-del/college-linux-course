name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
  pull_request_review:
    types: [submitted]

env:
  PROJECT_NUMBER: 4
  USER_LOGIN: virusneo1997-del

jobs:
  automate-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');
            
            // 1. –û–¢–õ–ê–î–ö–ê –î–û–°–¢–£–ü–ù–´–• –ü–†–û–ï–ö–¢–û–í
            try {
              console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã...');
              const debugQuery = `query {
                user(login: "${process.env.USER_LOGIN}") {
                  projectsV2(first: 20) {
                    nodes {
                      number
                      title
                      id
                    }
                  }
                }
              }`;
              
              const debugResult = await github.graphql(debugQuery);
              const projects = debugResult.user.projectsV2.nodes;
              console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:', JSON.stringify(projects, null, 2));
              
              if (projects.length === 0) {
                console.log('‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤!');
                console.log('üí° –°–æ–∑–¥–∞–π—Ç–µ Project Board –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ USER_LOGIN');
                return;
              }
              
              const targetProject = projects.find(p => p.number === parseInt(process.env.PROJECT_NUMBER));
              if (!targetProject) {
                console.log(`‚ùå –ü—Ä–æ–µ–∫—Ç —Å –Ω–æ–º–µ—Ä–æ–º ${process.env.PROJECT_NUMBER} –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                console.log('üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö –Ω–æ–º–µ—Ä–æ–≤:');
                projects.forEach(project => {
                  console.log(`- –ù–æ–º–µ—Ä: ${project.number}, –ù–∞–∑–≤–∞–Ω–∏–µ: "${project.title}"`);
                });
                console.log('üîÑ –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø—Ä–æ–µ–∫—Ç...');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                const fallbackProject = projects[0];
                console.log(`üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–µ–∫—Ç: "${fallbackProject.title}" (–Ω–æ–º–µ—Ä: ${fallbackProject.number})`);
                
                // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º
                process.env.PROJECT_NUMBER = fallbackProject.number;
              } else {
                console.log(`‚úÖ –¶–µ–ª–µ–≤–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–∞–π–¥–µ–Ω: "${targetProject.title}" (–Ω–æ–º–µ—Ä: ${targetProject.number})`);
              }
              
            } catch (error) {
              console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error.message);
              console.log('üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: USER_LOGIN –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Ç–æ–∫–µ–Ω–∞');
              return;
            }
            
            // 2. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò PR
            const { pull_request } = context.payload;
            if (!pull_request) {
              console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
              return;
            }
            
            const author = pull_request.user.login;
            const prAction = context.payload.action;
            const prState = pull_request.state;
            const prMerged = pull_request.merged;
            const prTitle = pull_request.title;
            
            console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
            console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
            console.log(`üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${prTitle}`);
            console.log(`üîÑ –°—Ç–∞—Ç—É—Å PR: ${prState}`);
            console.log(`‚úÖ –ú–µ—Ä–∂: ${prMerged}`);
            
            // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ù–û–í–´–ô –°–¢–ê–¢–£–° –î–õ–Ø –ö–ê–†–¢–û–ß–ö–ò
            let newStatus = null;
            
            if (context.eventName === 'pull_request') {
              console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ pull_request: ${prAction}`);
              
              switch (prAction) {
                case 'opened':
                  console.log('üéØ PR –æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º In Progress');
                  newStatus = 'In Progress';
                  break;
                  
                case 'reopened':
                  console.log('üéØ PR –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º In Progress');
                  newStatus = 'In Progress';
                  break;
                  
                case 'ready_for_review':
                  console.log('üéØ PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º In Review');
                  newStatus = 'In Review';
                  break;
                  
                case 'closed':
                  if (prMerged) {
                    console.log('üéØ PR –º–µ—Ä–∂–µ–Ω - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Done');
                    newStatus = 'Done';
                  } else {
                    console.log('üéØ PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –º–µ—Ä–∂–∞ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º To do');
                    newStatus = 'To do';
                  }
                  break;
                  
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
              }
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —Ä–µ–≤—å—é
            if (context.eventName === 'pull_request_review') {
              const reviewState = context.payload.review.state;
              console.log(`üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–≤—å—é: ${reviewState}`);
              
              if (reviewState === 'approved') {
                console.log('üéØ –†–µ–≤—å—é approved - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Done');
                newStatus = 'Done';
              }
            }
            
            if (!newStatus) {
              console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è');
              return;
            }
            
            console.log(`üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);
            
            try {
              // 3. –ü–û–õ–£–ß–ê–ï–ú ID –ü–†–û–ï–ö–¢–ê –ò –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ü–û–õ–Ø–•
              const projectQuery = `query getProject($user: String!, $number: Int!) {
                user(login: $user) {
                  projectV2(number: $number) {
                    id
                    title
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }`;
              
              console.log(`üîç –ò—â–µ–º –ø—Ä–æ–µ–∫—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å=${process.env.USER_LOGIN}, –Ω–æ–º–µ—Ä=${process.env.PROJECT_NUMBER}`);
              
              const projectResult = await github.graphql(projectQuery, {
                user: process.env.USER_LOGIN,
                number: parseInt(process.env.PROJECT_NUMBER)
              });
              
              const project = projectResult.user.projectV2;
              if (!project) {
                console.log('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏');
                return;
              }
              
              const projectId = project.id;
              console.log(`üìä –†–∞–±–æ—Ç–∞–µ–º —Å –ø—Ä–æ–µ–∫—Ç–æ–º: ${project.title} (ID: ${projectId})`);
              
              // 4. –ù–ê–•–û–î–ò–ú –ü–û–õ–ï STATUS
              const statusField = project.fields.nodes.find(field => field.name === 'Status');
              if (!statusField) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ');
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:', project.fields.nodes.map(f => f.name));
                return;
              }
              
              console.log(`üìã –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ Status: ${statusField.id}`);
              
              // 5. –ù–ê–•–û–î–ò–ú –û–ü–¶–ò–Æ –°–¢–ê–¢–£–°–ê
              if (!statusField.options) {
                console.log('‚ùå –£ –ø–æ–ª—è Status –Ω–µ—Ç –æ–ø—Ü–∏–π');
                return;
              }
              
              const statusOption = statusField.options.find(option => option.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ '${newStatus}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏:', statusField.options.map(o => o.name));
                return;
              }
              
              console.log(`üìã –ù–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${statusOption.name} (ID: ${statusOption.id})`);
              
              // 6. –ò–©–ï–ú –ö–ê–†–¢–û–ß–ö–£ –°–¢–£–î–ï–ù–¢–ê
              const itemsQuery = `query getProjectItems($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 50) {
                      nodes {
                        id
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              text
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }`;
              
              const itemsResult = await github.graphql(itemsQuery, { projectId });
              const items = itemsResult.node.items.nodes;
              
              console.log(`üîç –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞: ${author}`);
              console.log(`üìä –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –ø—Ä–æ–µ–∫—Ç–µ: ${items.length}`);
              
              // –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ Student GitHub
              const studentItem = items.find(item => {
                const githubField = item.fieldValues.nodes.find(f => 
                  f.field && f.field.name === 'Student GitHub'
                );
                return githubField && githubField.text === author;
              });
              
              if (!studentItem) {
                console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ:');
                items.forEach(item => {
                  const githubField = item.fieldValues.nodes.find(f => 
                    f.field && f.field.name === 'Student GitHub'
                  );
                  if (githubField) {
                    console.log(`- ${githubField.text}`);
                  }
                });
                return;
              }
              
              console.log(`üìé –ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞: ${studentItem.id}`);
              
              // 7. –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –ö–ê–†–¢–û–ß–ö–ò
              const updateMutation = `mutation updateProjectItem($input: UpdateProjectV2ItemFieldValueInput!) {
                updateProjectV2ItemFieldValue(input: $input) {
                  projectV2Item {
                    id
                  }
                }
              }`;
              
              const updateInput = {
                projectId,
                itemId: studentItem.id,
                fieldId: statusField.id,
                value: {
                  singleSelectOptionId: statusOption.id
                }
              };
              
              console.log('üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
              await github.graphql(updateMutation, { input: updateInput });
              
              console.log(`‚úÖ –£–°–ü–ï–•: –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Å—Ç–∞—Ç—É—Å: ${newStatus}`);
              
            } catch (error) {
              console.error('üí• –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:', error.message);
              if (error.errors) {
                console.log('üìã GraphQL –æ—à–∏–±–∫–∏:', JSON.stringify(error.errors, null, 2));
              }
            }
            
            console.log('=== üèÅ –ó–ê–í–ï–†–®–ï–ù–ò–ï –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');