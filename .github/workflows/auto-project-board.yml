name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed, converted_to_draft]

env:
  USER_LOGIN: "virusneo1997-del"

jobs:
  automate-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');
            
            // 1. –û–¢–õ–ê–î–ö–ê - –ü–û–ö–ê–ñ–ï–ú –í–°–ï –ü–†–û–ï–ö–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            try {
              console.log('üîç –ò—â–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
              const projectsQuery = `query {
                user(login: "${process.env.USER_LOGIN}") {
                  projectsV2(first: 10) {
                    nodes {
                      number
                      title
                      id
                      url
                    }
                  }
                }
              }`;
              
              const projectsResult = await github.graphql(projectsQuery);
              const projects = projectsResult.user.projectsV2.nodes;
              
              console.log('üìã –í–°–ï –ü–†–û–ï–ö–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:');
              projects.forEach((project, index) => {
                console.log(`${index + 1}. "${project.title}"`);
                console.log(`   –ù–æ–º–µ—Ä: ${project.number}`);
                console.log(`   ID: ${project.id}`);
                console.log(`   URL: ${project.url}`);
                console.log(`   ---`);
              });
              
              if (projects.length === 0) {
                console.log('‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤!');
                console.log('üí° –°–æ–∑–¥–∞–π—Ç–µ Project Board:');
                console.log('   1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://github.com/users/virusneo1997-del/projects/');
                console.log('   2. –ù–∞–∂–º–∏—Ç–µ "New project"');
                console.log('   3. –í—ã–±–µ—Ä–∏—Ç–µ "Board" —à–∞–±–ª–æ–Ω');
                console.log('   4. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ "Student GitHub" (Single text)');
                console.log('   5. –î–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
                return;
              }
              
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç
              const targetProject = projects[0];
              console.log(`üéØ –ò–°–ü–û–õ–¨–ó–£–ï–ú –ü–†–û–ï–ö–¢: "${targetProject.title}" (–Ω–æ–º–µ—Ä: ${targetProject.number})`);
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
              const projectId = targetProject.id;
              
              // 2. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò PR
              const { pull_request } = context.payload;
              if (!pull_request) {
                console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
                return;
              }
              
              const author = pull_request.user.login;
              const prAction = context.payload.action;
              const prState = pull_request.state;
              const prMerged = pull_request.merged;
              const prTitle = pull_request.title;
              const prDraft = pull_request.draft;
              
              console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
              console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
              console.log(`üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${prTitle}`);
              console.log(`üîÑ –°—Ç–∞—Ç—É—Å PR: ${prState}`);
              console.log(`‚úÖ –ú–µ—Ä–∂: ${prMerged}`);
              console.log(`üìù –ß–µ—Ä–Ω–æ–≤–∏–∫: ${prDraft}`);
              
              // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ù–û–í–´–ô –°–¢–ê–¢–£–°
              let newStatus = null;
              
              switch (prAction) {
                case 'opened':
                  newStatus = prDraft ? 'To do' : 'In Progress';
                  console.log(`üéØ PR –æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: ${newStatus}`);
                  break;
                  
                case 'reopened':
                  newStatus = 'In Progress';
                  console.log('üéØ PR –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: In Progress');
                  break;
                  
                case 'ready_for_review':
                  newStatus = 'In Review';
                  console.log('üéØ PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: In Review');
                  break;
                  
                case 'converted_to_draft':
                  newStatus = 'To do';
                  console.log('üéØ PR –≤ —á–µ—Ä–Ω–æ–≤–∏–∫–µ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: To do');
                  break;
                  
                case 'closed':
                  newStatus = prMerged ? 'Done' : 'To do';
                  console.log(`üéØ PR –∑–∞–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: ${newStatus}`);
                  break;
                  
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
                  return;
              }
              
              if (!newStatus) {
                console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è');
                return;
              }
              
              // 3. –ü–û–õ–£–ß–ê–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ü–†–û–ï–ö–¢–ï
              const projectDetailsQuery = `query GetProjectDetails($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    title
                    fields(first: 10) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                    items(first: 20) {
                      nodes {
                        id
                        fieldValues(first: 5) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              text
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }`;
              
              const projectDetails = await github.graphql(projectDetailsQuery, { projectId });
              const project = projectDetails.node;
              
              console.log(`üìä –ü—Ä–æ–µ–∫—Ç: ${project.title}`);
              
              // 4. –ù–ê–•–û–î–ò–ú –ü–û–õ–ï STATUS
              const statusField = project.fields.nodes.find(field => 
                field.name === 'Status' && field.options
              );
              
              if (!statusField) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç –æ–ø—Ü–∏–π');
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:', project.fields.nodes.map(f => ({
                  name: f.name,
                  hasOptions: !!f.options
                })));
                return;
              }
              
              console.log(`üìã –ü–æ–ª–µ Status: ${statusField.id}`);
              console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:', statusField.options.map(o => o.name));
              
              // 5. –ù–ê–•–û–î–ò–ú –û–ü–¶–ò–Æ –°–¢–ê–¢–£–°–ê
              const statusOption = statusField.options.find(option => option.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø–æ–ª–µ Status`);
                return;
              }
              
              console.log(`üìã –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${statusOption.name} (ID: ${statusOption.id})`);
              
              // 6. –ò–©–ï–ú –ö–ê–†–¢–û–ß–ö–£ –°–¢–£–î–ï–ù–¢–ê
              console.log(`üîç –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è: ${author}`);
              console.log(`üìä –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫: ${project.items.nodes.length}`);
              
              const studentItem = project.items.nodes.find(item => {
                const githubField = item.fieldValues.nodes.find(f => 
                  f.field && f.field.name === 'Student GitHub' && f.text
                );
                return githubField && githubField.text === author;
              });
              
              if (!studentItem) {
                console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã:');
                project.items.nodes.forEach(item => {
                  const githubField = item.fieldValues.nodes.find(f => 
                    f.field && f.field.name === 'Student GitHub' && f.text
                  );
                  if (githubField) {
                    const currentStatus = item.fieldValues.nodes.find(f => 
                      f.field && f.field.name === 'Status' && f.name
                    );
                    console.log(`- ${githubField.text} (—Å—Ç–∞—Ç—É—Å: ${currentStatus?.name || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'})`);
                  }
                });
                return;
              }
              
              console.log(`üìé –ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞: ${studentItem.id}`);
              
              // 7. –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–°
              const updateMutation = `mutation UpdateStatus($input: UpdateProjectV2ItemFieldValueInput!) {
                updateProjectV2ItemFieldValue(input: $input) {
                  projectV2Item {
                    id
                  }
                }
              }`;
              
              await github.graphql(updateMutation, {
                input: {
                  projectId: projectId,
                  itemId: studentItem.id,
                  fieldId: statusField.id,
                  value: { singleSelectOptionId: statusOption.id }
                }
              });
              
              console.log(`‚úÖ –£–°–ü–ï–•: ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ "${newStatus}"`);
              
            } catch (error) {
              console.error('üí• –û–®–ò–ë–ö–ê:', error.message);
              if (error.errors) {
                console.log('üìã GraphQL –æ—à–∏–±–∫–∏:', JSON.stringify(error.errors, null, 2));
              }
            }
            
            console.log('=== üèÅ –ó–ê–í–ï–†–®–ï–ù–ò–ï ===');