name: Auto Project Board

on:
  pull_request_target:
    types: [opened, reopened, synchronize, review_requested, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      issues: write
      contents: write

    steps:
      - name: Update Project V2
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const projectId = "PVT_kwHODlAJvM4BHrKr";
            const fieldName = "Status";

            const pr = context.payload.pull_request;
            if (!pr) {
              console.log("Not a PR event.");
              return;
            }

            const action = context.payload.action;
            const merged = pr.merged;
            const reviewers = pr.requested_reviewers || [];
            const hasReviewers = reviewers.length > 0;

            let fieldValue = null;

            if (action === "opened" || action === "reopened" || action === "synchronize") {
              fieldValue = "In Progress";
            } else if (action === "review_requested" || hasReviewers) {
              fieldValue = "In review";
            } else if (action === "closed" && merged) {
              fieldValue = "Done";
            } else if (action === "closed" && !merged) {
              fieldValue = "To do";
            }

            if (!fieldValue) {
              console.log("Nothing to update");
              return;
            }

            // Fetch fields
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                    items(first: 50) {
                      nodes {
                        id
                        content {
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(query, { projectId });
            const fields = projectData.node.fields.nodes;

            const statusField = fields.find(f => f.name === fieldName);
            if (!statusField) throw new Error(`Field "${fieldName}" not found`);

            const statusOption = statusField.options.find(o => o.name === fieldValue);
            if (!statusOption) throw new Error(`Option "${fieldValue}" not found`);

            // Check if PR already in project
            const existingItem = projectData.node.items.nodes.find(i => i.content?.id === pr.node_id);

            let itemId = null;

            if (existingItem) {
              itemId = existingItem.id;
            } else {
              // Add PR to project
              const addItem = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input:{
                    projectId: $projectId,
                    contentId: $contentId
                  }) {
                    item { id }
                  }
                }
              `, {
                projectId,
                contentId: pr.node_id
              });

              itemId = addItem.addProjectV2ItemById.item.id;
            }

            // Update status
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId,
              itemId,
              fieldId: statusField.id,
              optionId: statusOption.id
            });

            console.log(`Updated PR â†’ ${fieldValue}`);
