name: üîÑ Auto Project Board Sync

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  project: write

jobs:
  sync-project:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4

      - name: ü§ñ Auto update Project Board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            console.log("=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò –ü–†–û–ï–ö–¢–ê ===");

            const item = context.payload.issue || context.payload.pull_request;
            if (!item) {
              console.log("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω issue –∏–ª–∏ PR ‚Äî –≤—ã—Ö–æ–¥–∏–º.");
              return;
            }

            const projectName = "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–æ–≤";

            // === 1Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
            const projects = await github.graphql(`
              query {
                viewer {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      title
                      number
                    }
                  }
                }
              }
            `);

            const project = projects.viewer.projectsV2.nodes.find(p => p.title === projectName);
            if (!project) {
              console.log(`‚ùå –ü—Ä–æ–µ–∫—Ç "${projectName}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
              return;
            }

            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç "${project.title}" (ID: ${project.id})`);

            // === 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—è –ø—Ä–æ–µ–∫—Ç–∞ ===
            const projectDetails = await github.graphql(`
              query($id: ID!) {
                node(id: $id) {
                  ... on ProjectV2 {
                    fields(first: 50) {
                      nodes {
                        ... on ProjectV2FieldCommon { id name }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }
            `, { id: project.id });

            let fields = projectDetails.node.fields.nodes;
            let statusField = fields.find(f => f.name === "Status" && f.options);

            // === 3Ô∏è‚É£ –ï—Å–ª–∏ –ø–æ–ª—è Status –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –µ–≥–æ ===
            if (!statusField) {
              console.log("‚öôÔ∏è –ü–æ–ª–µ 'Status' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ...");

              const createFieldMutation = `
                mutation($input: CreateProjectV2FieldInput!) {
                  createProjectV2Field(input: $input) {
                    projectV2Field {
                      id
                      name
                    }
                  }
                }
              `;

              const createRes = await github.graphql(createFieldMutation, {
                input: {
                  projectId: project.id,
                  dataType: "SINGLE_SELECT",
                  name: "Status"
                }
              });

              const newFieldId = createRes.createProjectV2Field.projectV2Field.id;
              console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ –ø–æ–ª–µ Status (ID: ${newFieldId})`);

              // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –∫ –ø–æ–ª—é
              const addOptionMutation = `
                mutation($input: CreateProjectV2SingleSelectFieldOptionInput!) {
                  createProjectV2SingleSelectFieldOption(input: $input) {
                    projectV2SingleSelectFieldOption { id name }
                  }
                }
              `;

              const options = ["To do", "In progress", "In review", "Done"];
              for (const name of options) {
                await github.graphql(addOptionMutation, {
                  input: { fieldId: newFieldId, name }
                });
                console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø—Ü–∏—è: ${name}`);
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
              const updated = await github.graphql(`
                query($id: ID!) {
                  node(id: $id) {
                    ... on ProjectV2 {
                      fields(first: 50) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options { id name }
                          }
                        }
                      }
                    }
                  }
                }
              `, { id: project.id });

              fields = updated.node.fields.nodes;
              statusField = fields.find(f => f.name === "Status");
            }

            console.log(`üìã –ü–æ–ª–µ 'Status' –Ω–∞–π–¥–µ–Ω–æ (ID: ${statusField.id})`);
            console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: ${statusField.options.map(o => o.name).join(", ")}`);

            // === 4Ô∏è‚É£ –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –ø—Ä–æ–µ–∫—Ç ===
            const addItemMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
            `;

            let itemId = null;
            try {
              const res = await github.graphql(addItemMutation, {
                projectId: project.id,
                contentId: item.node_id,
              });
              itemId = res.addProjectV2ItemById.item.id;
              console.log(`‚úÖ –≠–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç: ${itemId}`);
            } catch (err) {
              console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ${err.message}`);
              if (err.message.includes("already exists")) {
                console.log("‚ÑπÔ∏è –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞.");
              }
            }

            // === 5Ô∏è‚É£ –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å ===
            const action = context.payload.action;
            const merged = item.merged || false;
            let newStatus = "To do";

            if (context.eventName === "pull_request") {
              switch (action) {
                case "opened": newStatus = "In progress"; break;
                case "ready_for_review": newStatus = "In review"; break;
                case "closed": newStatus = merged ? "Done" : "To do"; break;
              }
            } else if (context.eventName === "issues") {
              switch (action) {
                case "opened": newStatus = "To do"; break;
                case "reopened": newStatus = "In progress"; break;
                case "closed": newStatus = "Done"; break;
              }
            }

            console.log(`üéØ –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

            const option = statusField.options.find(o => o.name.toLowerCase() === newStatus.toLowerCase());
            if (!option) {
              console.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è "${newStatus}".`);
              return;
            }

            // === 6Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —ç–ª–µ–º–µ–Ω—Ç–∞ ===
            const updateMutation = `
              mutation($input: UpdateProjectV2ItemFieldValueInput!) {
                updateProjectV2ItemFieldValue(input: $input) {
                  projectV2Item { id }
                }
              }
            `;

            try {
              await github.graphql(updateMutation, {
                input: {
                  projectId: project.id,
                  itemId,
                  fieldId: statusField.id,
                  value: { singleSelectOptionId: option.id }
                }
              });
              console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω: ${newStatus}`);
            } catch (err) {
              console.log(`üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ${err.message}`);
            }

            console.log("=== üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–æ ===");
