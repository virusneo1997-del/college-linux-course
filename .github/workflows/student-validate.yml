name: Complete Student Workflow with Python Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, closed, review_requested]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    outputs:
      lesson_valid: ${{ steps.validate-structure.outputs.lesson_valid }}
      lesson_name: ${{ steps.find-lesson.outputs.lesson_name }}
      python_tests_passed: ${{ steps.run-python-tests.outputs.passed }}
      tests_output: ${{ steps.run-python-tests.outputs.tests_output }}
    steps:
      - name: Checkout student code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0  # –í–∞–∂–Ω–æ –¥–ª—è git diff

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Find lesson folder
        id: find-lesson
        run: |
          echo "üîç –ò—â–µ–º –ø–∞–ø–∫—É —É—Ä–æ–∫–∞..."
          lesson=$(find . -path "./lessons/[0-9]*-*" -type d | head -1)
          if [ -n "$lesson" ]; then
            lesson_name=$(basename "$lesson")
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞: $lesson_name"
            echo "lesson_name=$lesson_name" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –ü–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo "lesson_name=not_found" >> $GITHUB_OUTPUT
          fi

      - name: Validate lesson structure
        id: validate-structure
        run: |
          lesson_name="${{ steps.find-lesson.outputs.lesson_name }}"
          
          if [ "$lesson_name" = "not_found" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo "lesson_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          lesson_path="./lessons/$lesson_name"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ student-report.md
          if [ ! -f "$lesson_path/student-report.md" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç student-report.md –≤ $lesson_path"
            echo "lesson_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -s "$lesson_path/student-report.md" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: student-report.md –ø—É—Å—Ç–æ–π"
            echo "lesson_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è"
          echo "lesson_valid=true" >> $GITHUB_OUTPUT

      - name: Run Python tests for changed lessons
        id: run-python-tests
        run: |
          echo "üêç –ó–∞–ø—É—Å–∫–∞–µ–º Python —Ç–µ—Å—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤..."
          
          # –ü–æ–ª—É—á–∞–µ–º SHA –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"
          
          echo "üìä –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–º–º–∏—Ç—ã: $base_sha..$head_sha"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–≤–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤
          if python scripts/run_lesson_tests.py "$base_sha" "$head_sha"; then
            echo "‚úÖ –í—Å–µ Python —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "tests_output=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Python —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "tests_output=failed" >> $GITHUB_OUTPUT
          fi

  update-project-status:
    needs: validate-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Update Project Board based on test results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const projectId = "PVT_kwHODlAJvM4BHrKr";
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
            const structureValid = "${{ needs.validate-and-test.outputs.lesson_valid }}" === "true";
            const pythonTestsPassed = "${{ needs.validate-and-test.outputs.python_tests_passed }}" === "true";
            const testsOutput = "${{ needs.validate-and-test.outputs.tests_output }}";
            
            let status = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";
            const prAction = context.payload.action;
            const isMerged = context.payload.pull_request?.merged;
            
            console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞=${structureValid}, —Ç–µ—Å—Ç—ã=${pythonTestsPassed}, –≤—ã–≤–æ–¥=${testsOutput}`);
            
            // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –í–°–ï–• –ø—Ä–æ–≤–µ—Ä–æ–∫
            if (prAction === "closed" && isMerged) {
              if (structureValid && pythonTestsPassed) {
                status = "–ì–æ—Ç–æ–≤–æ";
              } else {
                status = "–¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π";
              }
            } else if (prAction === "review_requested") {
              status = "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ";
            } else if (prAction === "opened" || prAction === "reopened") {
              if (structureValid && pythonTestsPassed) {
                status = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";
              } else if (!structureValid) {
                status = "–¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π";
              } else if (structureValid && !pythonTestsPassed) {
                status = "–¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã";
              }
            }

            console.log(`üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å: ${status}`);

            try {
              // –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
              const addResult = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId,
                    contentId: $contentId
                  }) {
                    item { id }
                  }
                }
              `, {
                projectId,
                contentId: context.payload.pull_request.node_id
              });

              const itemId = addResult.addProjectV2ItemById.item.id;

              // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—è –ø—Ä–æ–µ–∫—Ç–∞
              const projectData = await github.graphql(`
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 10) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, { projectId });

              const statusField = projectData.node.fields.nodes.find(f => f.name === "–°—Ç–∞—Ç—É—Å");
              
              if (!statusField) {
                console.log("‚ùå –ü–æ–ª–µ '–°—Ç–∞—Ç—É—Å' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ");
                return;
              }

              const statusOption = statusField.options.find(o => o.name === status);
              
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è '${status}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –î–æ—Å—Ç—É–ø–Ω—ã–µ: ${statusField.options.map(o => o.name).join(', ')}`);
                return;
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: statusField.id,
                optionId: statusOption.id
              });

              console.log(`‚úÖ Project Board –æ–±–Ω–æ–≤–ª–µ–Ω: ${status}`);

            } catch (error) {
              console.log("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å Project Board:", error.message);
            }

  post-detailed-results:
    needs: [validate-and-test, update-project-status]
    runs-on: ubuntu-latest
    steps:
      - name: Post detailed test results to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const isValid = "${{ needs.validate-and-test.outputs.lesson_valid }}" === "true";
            const pythonPassed = "${{ needs.validate-and-test.outputs.python_tests_passed }}" === "true";
            const lessonName = "${{ needs.validate-and-test.outputs.lesson_name }}";
            
            let comment = "## üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏\\n\\n";
            
            if (isValid && pythonPassed) {
              comment += "üéâ **–í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!**\\n";
              comment += `üìÅ –ü–∞–ø–∫–∞ —É—Ä–æ–∫–∞: ${lessonName}\\n`;
              comment += "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞\\n";
              comment += "‚úÖ Python —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã\\n";
              comment += "üöÄ –ó–∞–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–≤—å—é!";
            } else if (isValid && !pythonPassed) {
              comment += "‚ö†Ô∏è **–°–¢–†–£–ö–¢–£–†–ê OK, –ù–û –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´**\\n";
              comment += `üìÅ –ü–∞–ø–∫–∞ —É—Ä–æ–∫–∞: ${lessonName}\\n`;
              comment += "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞\\n";
              comment += "‚ùå Python —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã\\n";
              comment += "üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ —Ç–µ—Å—Ç–æ–≤ –≤—ã—à–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥";
            } else if (!isValid) {
              comment += "‚ùå **–ü–†–û–ë–õ–ï–ú–´ –°–û –°–¢–†–£–ö–¢–£–†–û–ô**\\n";
              comment += "‚Ä¢ –ü–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ò–õ–ò\\n";
              comment += "‚Ä¢ student-report.md –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ò–õ–ò\\n";
              comment += "‚Ä¢ student-report.md –ø—É—Å—Ç–æ–π\\n";
              comment += "üîß –ò—Å–ø—Ä–∞–≤—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ PR";
            }
            
            comment += "\\n\\n---\\n*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ College Linux Course*";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });