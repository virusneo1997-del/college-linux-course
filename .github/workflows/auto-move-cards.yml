name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫

on:
  pull_request:
    types: [opened, ready_for_review, closed, reopened]

permissions:
  contents: read
  pull-requests: write
  repository-projects: write

jobs:
  move-project-card:
    runs-on: ubuntu-latest
    steps:
      - name: üìä –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
        uses: actions/github-script@v6
        with:
          script: |
            const automateProjectCard = async ({ github, context }) => {
              // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
              const PROJECT_NUMBER = 4;
              const OWNER = 'virusneo1997-del';
              const IS_ORGANIZATION = false;

              console.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è PR:', context.payload.pull_request?.number);
              console.log(`–°–æ–±—ã—Ç–∏–µ: ${context.eventName}, –î–µ–π—Å—Ç–≤–∏–µ: ${context.payload.action}`);
              console.log(`–ê–≤—Ç–æ—Ä PR: ${context.payload.pull_request?.user?.login}`);

              try {
                // 1. –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞
                const projectId = await getProjectId(github, OWNER, PROJECT_NUMBER, IS_ORGANIZATION);
                if (!projectId) {
                  console.log('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                  return;
                }

                // 2. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ Status
                const statusField = await getStatusField(github, projectId);
                if (!statusField) {
                  console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                  return;
                }

                // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ—Ä–∞ PR
                const author = context.payload.pull_request?.user?.login;
                if (!author) {
                  console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ—Ä–∞ PR');
                  return;
                }

                // 4. –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
                const studentCard = await findStudentCard(github, projectId, author);
                if (!studentCard) {
                  console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                  return;
                }

                // 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏—è PR
                const newStatus = await determineNewStatus(github, context, projectId, studentCard.id, statusField);
                if (!newStatus) {
                  console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è');
                  return;
                }

                // 6. –ù–∞—Ö–æ–¥–∏–º ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
                const statusOptionId = findStatusOptionId(statusField, newStatus);
                if (!statusOptionId) {
                  console.log(`‚ùå –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                  return;
                }

                // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏
                await updateCardStatus(github, projectId, studentCard.id, statusField.id, statusOptionId);
                
                console.log(`üéâ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

              } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:', error);
              }
            };

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø—Ä–æ–µ–∫—Ç–∞
            async function getProjectId(github, owner, projectNumber, isOrganization = false) {
              const entityType = isOrganization ? 'organization' : 'user';
              
              const query = `
                query {
                  ${entityType}(login: "${owner}") {
                    projectV2(number: ${projectNumber}) {
                      id
                      title
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                return result[entityType]?.projectV2?.id;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–∞: ${error.message}`);
                throw error;
              }
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—è Status
            async function getStatusField(github, projectId) {
              const query = `
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                const fields = result.node.fields.nodes;
                return fields.find(field => field.name === 'Status');
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª–µ–π: ${error.message}`);
                throw error;
              }
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
            async function findStudentCard(github, projectId, studentGitHub) {
              const query = `
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                                text
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                const items = result.node.items.nodes;
                
                return items.find(item => {
                  const githubField = item.fieldValues.nodes.find(f => 
                    f.field?.name === 'Student GitHub' && f.text === studentGitHub
                  );
                  return githubField;
                });
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏: ${error.message}`);
                throw error;
              }
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            async function getCurrentStatus(github, projectId, itemId, statusField) {
              const query = `
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      item(id: "${itemId}") {
                        fieldValueByName(name: "Status") {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                return result.node.item.fieldValueByName?.name;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`);
                return null;
              }
            }

            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
            async function determineNewStatus(github, context, projectId, itemId, statusField) {
              const event = context.eventName;
              const action = context.payload.action;
              const pr = context.payload.pull_request;

              console.log(`üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: event=${event}, action=${action}`);
              console.log(`üîç PR merged: ${pr?.merged}, state: ${pr?.state}`);

              if (event === 'pull_request') {
                switch (action) {
                  case 'opened':
                    console.log('üìù PR –æ—Ç–∫—Ä—ã—Ç ‚Üí –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "In process"');
                    return 'In process';
                  
                  case 'reopened':
                    console.log('üîÑ PR –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç ‚Üí –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "In process"');
                    return 'In process';
                  
                  case 'ready_for_review':
                    console.log('üëÄ PR –≥–æ—Ç–æ–≤ –∫ —Ä–µ–≤—å—é ‚Üí –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "In review"');
                    return 'In review';
                  
                  case 'closed':
                    // –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–µ—Ä–∂
                    const isMerged = pr && pr.merged === true;
                    console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ä–∂–∞: merged=${pr?.merged}, merged_at=${pr?.merged_at}`);
                    
                    if (isMerged) {
                      console.log('‚úÖ PR –í–ú–ï–†–ñ–ï–ù ‚Üí –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "Done"');
                      return 'Done';
                    } else {
                      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
                      const currentStatus = await getCurrentStatus(github, projectId, itemId, statusField);
                      console.log(`üí§ PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –º–µ—Ä–∂–∞ ‚Üí –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞—Ç—É—Å–µ: "${currentStatus}"`);
                      return null; // –ù–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
                    }
                  
                  default:
                    console.log(`‚ÑπÔ∏è –î–µ–π—Å—Ç–≤–∏–µ ${action} –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è`);
                    return null;
                }
              }

              console.log(`‚ÑπÔ∏è –°–æ–±—ã—Ç–∏–µ ${event} –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è`);
              return null;
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
            function findStatusOptionId(statusField, statusName) {
              if (!statusField?.options) return null;
              
              // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
              let option = statusField.options.find(opt => opt.name === statusName);
              
              // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ (–Ω–∞ —Å–ª—É—á–∞–π –æ–ø–µ—á–∞—Ç–æ–∫)
              if (!option) {
                const similarOptions = statusField.options.filter(opt => 
                  opt.name.toLowerCase().includes(statusName.toLowerCase()) ||
                  statusName.toLowerCase().includes(opt.name.toLowerCase())
                );
                if (similarOptions.length > 0) {
                  option = similarOptions[0];
                  console.log(`üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ö–æ–∂–∏–π —Å—Ç–∞—Ç—É—Å: "${option.name}" –≤–º–µ—Å—Ç–æ "${statusName}"`);
                }
              }
              
              return option?.id;
            }

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            async function updateCardStatus(github, projectId, itemId, fieldId, optionId) {
              const mutation = `
                mutation {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: "${projectId}"
                      itemId: "${itemId}"
                      fieldId: "${fieldId}"
                      value: {
                        singleSelectOptionId: "${optionId}"
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(mutation);
            }

            // –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
            await automateProjectCard({ github, context });
