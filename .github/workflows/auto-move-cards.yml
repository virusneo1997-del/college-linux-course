name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫

on:
  pull_request:
    types: [opened, ready_for_review, closed]

permissions:
  contents: read
  pull-requests: write
  repository-projects: write

jobs:
  move-project-card:
    runs-on: ubuntu-latest
    steps:
      - name: üìä –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
        uses: actions/github-script@v6
        with:
          script: |
            const automateProjectCard = async ({ github, context }) => {
              // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –∑–∞–º–µ–Ω–∏ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è!
              const PROJECT_NUMBER = 4; // –ù–æ–º–µ—Ä —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
              const OWNER = 'virusneo1997-del'; // –¢–≤–æ–π username
              const IS_ORGANIZATION = false; // false –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

              console.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è PR:', context.payload.pull_request?.number);
              console.log(`–°–æ–±—ã—Ç–∏–µ: ${context.eventName}, –î–µ–π—Å—Ç–≤–∏–µ: ${context.payload.action}`);
              console.log(`–ê–≤—Ç–æ—Ä PR: ${context.payload.pull_request?.user?.login}`);

              try {
                // 1. –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞
                const projectId = await getProjectId(github, OWNER, PROJECT_NUMBER, IS_ORGANIZATION);
                if (!projectId) {
                  console.log('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                  return;
                }
                console.log(`‚úÖ ID –ø—Ä–æ–µ–∫—Ç–∞: ${projectId}`);

                // 2. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ Status
                const statusField = await getStatusField(github, projectId);
                if (!statusField) {
                  console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                  return;
                }
                console.log(`‚úÖ –ü–æ–ª–µ Status –Ω–∞–π–¥–µ–Ω–æ. –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã: ${statusField.options.map(opt => opt.name).join(', ')}`);

                // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ—Ä–∞ PR
                const author = context.payload.pull_request?.user?.login;
                if (!author) {
                  console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ—Ä–∞ PR');
                  return;
                }
                console.log(`‚úÖ –ê–≤—Ç–æ—Ä PR: ${author}`);

                // 4. –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞
                const studentCard = await findStudentCard(github, projectId, author);
                if (!studentCard) {
                  console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                  // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –ø–æ–ª—é "GitHub" –∏–ª–∏ "Username"
                  const alternativeCard = await findStudentCardAlternative(github, projectId, author);
                  if (!alternativeCard) {
                    console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞–∂–µ –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º –ø–æ–ª—è–º`);
                    return;
                  }
                  console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –ø–æ–ª—é`);
                }
                const card = studentCard || alternativeCard;
                console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞, ID: ${card.id}`);

                // 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏—è PR
                const newStatus = determineNewStatus(context);
                if (!newStatus) {
                  console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å');
                  return;
                }
                console.log(`‚úÖ –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

                // 6. –ù–∞—Ö–æ–¥–∏–º ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
                const statusOptionId = findStatusOptionId(statusField, newStatus);
                if (!statusOptionId) {
                  console.log(`‚ùå –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                  return;
                }
                console.log(`‚úÖ ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ${statusOptionId}`);

                // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏
                await updateCardStatus(github, projectId, card.id, statusField.id, statusOptionId);
                
                console.log(`üéâ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Å—Ç–∞—Ç—É—Å: ${newStatus}`);

              } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:', error);
                console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message);
              }
            };

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø—Ä–æ–µ–∫—Ç–∞
            async function getProjectId(github, owner, projectNumber, isOrganization = false) {
              const entityType = isOrganization ? 'organization' : 'user';
              
              const query = `
                query {
                  ${entityType}(login: "${owner}") {
                    projectV2(number: ${projectNumber}) {
                      id
                      title
                    }
                  }
                }
              `;
              
              console.log(`üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞: ${entityType}="${owner}", –Ω–æ–º–µ—Ä=${projectNumber}`);
              
              try {
                const result = await github.graphql(query);
                const project = result[entityType]?.projectV2;
                if (project) {
                  console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: "${project.title}"`);
                }
                return project?.id;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–∞: ${error.message}`);
                throw error;
              }
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—è Status
            async function getStatusField(github, projectId) {
              const query = `
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                const fields = result.node.fields.nodes;
                const statusField = fields.find(field => field.name === 'Status');
                return statusField;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª–µ–π: ${error.message}`);
                throw error;
              }
            }

            // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
            async function findStudentCard(github, projectId, studentGitHub) {
              const query = `
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                                text
                              }
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                const items = result.node.items.nodes;
                
                const studentCard = items.find(item => {
                  const githubField = item.fieldValues.nodes.find(f => 
                    f.field?.name === 'Student GitHub' && f.text === studentGitHub
                  );
                  return githubField;
                });

                return studentCard;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏: ${error.message}`);
                throw error;
              }
            }

            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ (–µ—Å–ª–∏ –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ-–¥—Ä—É–≥–æ–º—É)
            async function findStudentCardAlternative(github, projectId, studentGitHub) {
              const query = `
                query {
                  node(id: "${projectId}") {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                                text
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              try {
                const result = await github.graphql(query);
                const items = result.node.items.nodes;
                
                // –ò—â–µ–º –ø–æ —Ä–∞–∑–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏—è–º –ø–æ–ª–µ–π
                const possibleFields = ['GitHub', 'Username', 'Login', 'Student', 'GitHub Username'];
                
                for (let item of items) {
                  for (let fieldName of possibleFields) {
                    const field = item.fieldValues.nodes.find(f => 
                      f.field?.name === fieldName && f.text && f.text.toLowerCase() === studentGitHub.toLowerCase()
                    );
                    if (field) {
                      console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø–æ–ª—é "${fieldName}"`);
                      return item;
                    }
                  }
                  
                  // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π field, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç GitHub username
                  const anyField = item.fieldValues.nodes.find(f => 
                    f.text && f.text.toLowerCase() === studentGitHub.toLowerCase()
                  );
                  if (anyField) {
                    console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø–æ–ª—é "${anyField.field?.name}"`);
                    return item;
                  }
                }
                
                return null;
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º –ø–æ–∏—Å–∫–µ: ${error.message}`);
                return null;
              }
            }

            // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π PR
            function determineNewStatus(context) {
              const event = context.eventName;
              const action = context.payload.action;
              const pr = context.payload.pull_request;

              console.log(`üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: event=${event}, action=${action}, merged=${pr?.merged}`);

              if (event === 'pull_request') {
                switch (action) {
                  case 'opened':
                    return 'In process'; // PR —Å–æ–∑–¥–∞–Ω - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "In process"
                  case 'ready_for_review':
                    return 'In review'; // PR –≥–æ—Ç–æ–≤ –∫ —Ä–µ–≤—å—é - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "In review"
                  case 'closed':
                    if (pr?.merged) {
                      return 'Done'; // PR –≤–º–µ—Ä–∂–µ–Ω - –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "Done"
                    } else {
                      return 'To do'; // PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –º–µ—Ä–∂–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ "To do"
                    }
                }
              }

              console.log(`‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è event=${event}, action=${action}`);
              return null;
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ ID –æ–ø—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
            function findStatusOptionId(statusField, statusName) {
              if (!statusField || !statusField.options) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –∏–º–µ–µ—Ç –æ–ø—Ü–∏–π');
                return null;
              }

              // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
              let option = statusField.options.find(opt => opt.name === statusName);
              
              // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
              if (!option) {
                const similarOptions = statusField.options.filter(opt => 
                  opt.name.toLowerCase().includes(statusName.toLowerCase()) ||
                  statusName.toLowerCase().includes(opt.name.toLowerCase())
                );
                if (similarOptions.length > 0) {
                  option = similarOptions[0];
                  console.log(`üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ö–æ–∂–∏–π —Å—Ç–∞—Ç—É—Å: "${option.name}" –≤–º–µ—Å—Ç–æ "${statusName}"`);
                }
              }

              return option?.id;
            }

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            async function updateCardStatus(github, projectId, itemId, fieldId, optionId) {
              const mutation = `
                mutation {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: "${projectId}"
                      itemId: "${itemId}"
                      fieldId: "${fieldId}"
                      value: {
                        singleSelectOptionId: "${optionId}"
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              try {
                await github.graphql(mutation);
                console.log('‚úÖ –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
              } catch (error) {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`);
                throw error;
              }
            }

            // –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
            await automateProjectCard({ github, context });
