name: Update Project Status

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  update-project:
    runs-on: ubuntu-latest

    steps:
      - name: Set PR Status in Project v2
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const projectId = "PVT_kwHODlAJvM4BHrKr";
            const statusFieldId = "PVTSSF_lAHODlAJvM4BHrKrzg4W_H4";

            const STATUS = {
              TODO: "f75ad846",
              IN_PROGRESS: "47fc9ee4",
              IN_REVIEW: "a5af56b4",
              DONE: "98236657"
            };

            const pr = context.payload.pull_request;

            let newStatus = null;

            if (pr.merged) {
              newStatus = STATUS.DONE;
            } else if (pr.state === "closed") {
              newStatus = STATUS.TODO;
            } else if (pr.requested_reviewers.length > 0) {
              newStatus = STATUS.IN_REVIEW;
            } else {
              newStatus = STATUS.IN_PROGRESS;
            }

            await github.graphql(`
              mutation($projectId: ID!, $prId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId,
                    itemId: $prId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId,
              prId: pr.node_id,
              fieldId: statusFieldId,
              optionId: newStatus
            });
