name: Update Project Status

on:
  pull_request:
    types: [opened, reopened, synchronize, closed, review_requested]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Update Personal Project Board
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            const projectId = "PVT_kwHODlAJvM4BHrKr"; 
            const fieldName = "–°—Ç–∞—Ç—É—Å";
            const pr = context.payload.pull_request;
            
            if (!pr) {
              console.log("‚ùå –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å pull request.");
              return;
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            let fieldValue = null;
            const action = context.payload.action;
            const merged = pr.merged;
            const hasReviewers = pr.requested_reviewers?.length > 0;

            if (action === "opened" || action === "reopened" || action === "synchronize") {
              fieldValue = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";
            } else if (action === "review_requested" || hasReviewers) {
              fieldValue = "–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏";
            } else if (action === "closed" && merged) {
              fieldValue = "–ì–æ—Ç–æ–≤–æ";
            } else if (action === "closed" && !merged) {
              fieldValue = "–í —Ä–∞–±–æ—Ç–µ";
            }

            if (!fieldValue) {
              console.log("‚ÑπÔ∏è –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º ‚Äî —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞.");
              return;
            }

            try {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–µ–∫—Ç—É - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ó–ê–ü–†–û–°
              const projectQuery = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectResult = await github.graphql(projectQuery, { projectId });
              
              if (!projectResult.node) {
                throw new Error(`–ü—Ä–æ–µ–∫—Ç —Å ID ${projectId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
              }

              console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${projectResult.node.title}`);

              const fields = projectResult.node.fields.nodes;
              const statusField = fields.find(f => f.name === fieldName);
              
              if (!statusField) {
                const availableFields = fields.map(f => f.name).join(', ');
                console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è: ${availableFields}`);
                throw new Error(`–ü–æ–ª–µ "${fieldName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ`);
              }

              const statusOption = statusField.options.find(o => o.name === fieldValue);
              if (!statusOption) {
                const availableOptions = statusField.options.map(o => o.name).join(', ');
                console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏: ${availableOptions}`);
                throw new Error(`–û–ø—Ü–∏—è "${fieldValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
              }

              // –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
              console.log(`–î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç...`);
              const addItemResult = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId,
                    contentId: $contentId
                  }) {
                    item { id }
                  }
                }
              `, {
                projectId,
                contentId: pr.node_id
              });

              const itemId = addItemResult.addProjectV2ItemById.item.id;
              console.log(`‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç, item ID: ${itemId}`);

              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              await github.graphql(`
                mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: statusField.id,
                optionId: statusOption.id
              });

              console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚Üí "${fieldValue}"`);

            } catch (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞:", error.message);
              
              // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∂–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
              if (error.message.includes("–Ω–µ –Ω–∞–π–¥–µ–Ω")) {
                console.log("üîÑ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤...");
                const projectsQuery = `
                  query($user: String!) {
                    user(login: $user) {
                      projectsV2(first: 10) {
                        nodes {
                          id
                          title
                          number
                        }
                      }
                    }
                  }
                `;
                
                try {
                  const projectsResult = await github.graphql(projectsQuery, {
                    user: context.repo.owner
                  });
                  
                  console.log("=== –í–ê–®–ò –ü–†–û–ï–ö–¢–´ ===");
                  projectsResult.user.projectsV2.nodes.forEach(project => {
                    console.log(`–ù–∞–∑–≤–∞–Ω–∏–µ: ${project.title}, ID: ${project.id}`);
                  });
                } catch (debugError) {
                  console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤:", debugError.message);
                }
              }
            }