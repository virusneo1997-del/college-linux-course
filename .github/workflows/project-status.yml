name: Update Project Status

on:
  pull_request:
    types: [opened, reopened, synchronize, closed, review_requested]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Update Personal Project Board
        uses: actions/github-script@v7  # ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å v6 –Ω–∞ v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            console.log("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...");
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
            if (!process.env.GITHUB_TOKEN) {
              console.log("‚ùå GITHUB_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
              return;
            }

            const projectId = "PVT_kwHODlAJvM4BHrKr"; 
            const fieldName = "–°—Ç–∞—Ç—É—Å";
            const pr = context.payload.pull_request;
            
            if (!pr) {
              console.log("‚ùå –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å pull request.");
              return;
            }

            console.log(`üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º PR: #${pr.number} - ${pr.title}`);
            console.log(`üîÑ –î–µ–π—Å—Ç–≤–∏–µ: ${context.payload.action}, –û–±—ä–µ–¥–∏–Ω–µ–Ω: ${pr.merged}`);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            let fieldValue = null;
            const action = context.payload.action;
            const merged = pr.merged;
            const hasReviewers = pr.requested_reviewers?.length > 0;

            if (action === "opened" || action === "reopened" || action === "synchronize") {
              fieldValue = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";
            } else if (action === "review_requested" || hasReviewers) {
              fieldValue = "–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏";
            } else if (action === "closed" && merged) {
              fieldValue = "–ì–æ—Ç–æ–≤–æ";
            } else if (action === "closed" && !merged) {
              fieldValue = "–í —Ä–∞–±–æ—Ç–µ";
            }

            if (!fieldValue) {
              console.log("‚ÑπÔ∏è –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º ‚Äî —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞.");
              return;
            }

            console.log(`üìå –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${fieldValue}`);

            try {
              // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
              console.log("üîç –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ...");
              
              // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç
              console.log("‚ûï –î–æ–±–∞–≤–ª—è–µ–º PR –≤ –ø—Ä–æ–µ–∫—Ç...");
              const addItemResult = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId,
                    contentId: $contentId
                  }) {
                    item { 
                      id 
                    }
                  }
                }
              `, {
                projectId,
                contentId: pr.node_id
              });

              const itemId = addItemResult.addProjectV2ItemById.item.id;
              console.log(`‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç, ID —ç–ª–µ–º–µ–Ω—Ç–∞: ${itemId}`);

              // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—è—Ö –ø—Ä–æ–µ–∫—Ç–∞
              const projectQuery = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectResult = await github.graphql(projectQuery, { projectId });
              
              if (!projectResult.node) {
                throw new Error(`–ü—Ä–æ–µ–∫—Ç —Å ID ${projectId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
              }

              console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${projectResult.node.title}`);

              const fields = projectResult.node.fields.nodes;
              const statusField = fields.find(f => f.name === fieldName);
              
              if (!statusField) {
                const availableFields = fields.map(f => f.name).join(', ');
                console.log(`‚ùå –ü–æ–ª–µ "${fieldName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ`);
                console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è: ${availableFields}`);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø–æ–ª–µ
                if (fields.length > 0) {
                  const firstField = fields[0];
                  console.log(`üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ: ${firstField.name}`);
                  // –î–ª—è –¥–µ–º–æ - –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
                  return;
                }
                throw new Error(`–ü–æ–ª–µ "${fieldName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ`);
              }

              const statusOption = statusField.options.find(o => o.name === fieldValue);
              if (!statusOption) {
                const availableOptions = statusField.options.map(o => o.name).join(', ');
                console.log(`‚ùå –û–ø—Ü–∏—è "${fieldValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏: ${availableOptions}`);
                return;
              }

              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
              console.log("üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å...");
              await github.graphql(`
                mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: statusField.id,
                optionId: statusOption.id
              });

              console.log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚Üí "${fieldValue}"`);

            } catch (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞:", error.message);
              
              if (error.message.includes("already exists")) {
                console.log("‚ÑπÔ∏è PR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ, –≤—Å–µ —Ö–æ—Ä–æ—à–æ");
              } else if (error.message.includes("Resource not accessible")) {
                console.log("üîê –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É");
                console.log("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ PERSONAL_ACCESS_TOKEN –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞");
              }
            }