name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-student:
    runs-on: ubuntu-latest

    steps:
      - name: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Pull Request
        run: |
          echo "PR –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞: ${{ github.event.pull_request.user.login }}"
          echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "–í–µ—Ç–∫–∞: ${{ github.event.pull_request.head.ref }}"

      # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–∏—Ö PR –≤–µ—Ç–∫—É)
      - name: Checkout student's repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–∫ –∏–∑ –ø—É—Ç–∏
        id: lesson
        run: |
          echo "=== –ü–æ–∏—Å–∫ –ø–∞–ø–æ–∫ —É—Ä–æ–∫–æ–≤ –≤ lessons/ ==="
          
          # –ò—â–µ–º –ø–∞–ø–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ (01-, 02-, –∏ —Ç.–¥.)
          if [ -d "lessons" ]; then
            echo "–ü–∞–ø–∫–∞ lessons —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            find lessons -maxdepth 1 -type d -name "[0-9]*-*" | sort || echo "–ü–∞–ø–∫–∏ —É—Ä–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            
            lesson=$(find lessons -maxdepth 1 -type d -name "[0-9]*-*" | head -n 1)
            
            if [ -z "$lesson" ]; then
              echo "‚ùå –ü–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ lessons/"
              echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ lessons:"
              ls -la lessons/
              echo "lesson=not_found" >> $GITHUB_OUTPUT
            else
              lesson_name=$(basename "$lesson")
              echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ —É—Ä–æ–∫–∞: $lesson_name"
              echo "lesson=$lesson_name" >> $GITHUB_OUTPUT
              echo "full_path=$lesson" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå –ü–∞–ø–∫–∞ lessons –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "lesson=not_found" >> $GITHUB_OUTPUT
          fi

      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        run: |
          if [ "${{ steps.lesson.outputs.lesson }}" = "not_found" ]; then
            echo "::error ::–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ —É—Ä–æ–∫–∞ –≤ –ø–∞–ø–∫–µ lessons."
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–ø–∫–∏: 01-initial-setup, 02-users-permissions, 03-web-server, –∏ —Ç.–¥."
            exit 1
          fi

          echo "–ù–∞–π–¥–µ–Ω —É—Ä–æ–∫: ${{ steps.lesson.outputs.lesson }}"
          echo "–ü–æ–ª–Ω—ã–π –ø—É—Ç—å: ${{ steps.lesson.outputs.full_path }}"

          lesson_dir="${{ steps.lesson.outputs.full_path }}"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
          if [ ! -f "$lesson_dir/student-report.md" ]; then
            echo "::error ::–í –ø–∞–ø–∫–µ —É—Ä–æ–∫–∞ $lesson_dir –Ω–µ—Ç —Ñ–∞–π–ª–∞ student-report.md"
            echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª student-report.md –≤ –ø–∞–ø–∫–µ $lesson_dir"
            exit 1
          fi

          echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∞–ª–∏–¥–Ω–∞ ‚úî"

      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ student-report.md
        run: |
          file="${{ steps.lesson.outputs.full_path }}/student-report.md"

          echo "---- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ student-report.md ----"
          cat "$file" || echo "–§–∞–π–ª –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è"
          echo "--------------------------------------"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
          if [ ! -s "$file" ]; then
            echo "::error ::–§–∞–π–ª student-report.md –ø—É—Å—Ç–æ–π"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
          if ! grep -qi -E "–æ—Ç–≤–µ—Ç|solution|—Ä–µ—à–µ–Ω–∏–µ|–æ—Ç—á–µ—Ç|report|–∑–∞–¥–∞–Ω–∏–µ|task" "$file"; then
            echo "::warning ::–§–∞–π–ª –µ—Å—Ç—å, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è."
          else
            echo "‚úÖ –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç"
          fi

      - name: –£—Å–ø–µ—à–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if: success()
        run: |
          echo "üéâ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
          echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞: ${{ steps.lesson.outputs.lesson }}"
          echo "‚úÖ –§–∞–π–ª student-report.md –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π"

      - name: –ù–µ—É—Å–ø–µ—à–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if: failure()
        run: |
          echo "‚ùå –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –æ—à–∏–±–∫–æ–π"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏—è –≤—ã—à–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É"