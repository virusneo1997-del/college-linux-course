name: Check Student Submission

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Move PR to "In Progress"
        if: github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const PROJECT_ID = "ВАШ_PROJECT_ID"; // вставь сюда!

            const item = await github.graphql(`
              mutation($project: ID!, $pr: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $project,
                  contentId: $pr
                }) {
                  item {
                    id
                  }
                }
              }
            `, {
              project: PROJECT_ID,
              pr: context.payload.pull_request.node_id
            });

            const itemId = item.addProjectV2ItemById.item.id;

            await github.graphql(`
              mutation($project: ID!, $item: ID!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project,
                  itemId: $item,
                  fieldId: "Status",
                  value: { singleSelectOptionId: "in_progress" }
                }) {
                  clientMutationId
                }
              }
            `, {
              project: PROJECT_ID,
              item: itemId
            });

  move-to-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.requested_reviewers
    steps:
      - name: Move PR to "In Review"
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const PROJECT_ID = "ВАШ_PROJECT_ID"; // вставь сюда

            const prNodeId = context.payload.pull_request.node_id;

            const item = await github.graphql(`
              query($project: ID!, $pr: ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { project: PROJECT_ID });

            const found = item.node.items.nodes.find(i => i.content?.id === prNodeId);

            if (!found) return;

            await github.graphql(`
              mutation($project: ID!, $item: ID!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project,
                  itemId: $item,
                  fieldId: "Status",
                  value: { singleSelectOptionId: "in_review" }
                }) {
                  clientMutationId
                }
              }
            `, {
              project: PROJECT_ID,
              item: found.id
            });

  move-to-done:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Move PR to Done
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const PROJECT_ID = "ВАШ_PROJECT_ID"; // вставь сюда

            const prNodeId = context.payload.pull_request.node_id;

            const item = await github.graphql(`
              query($project: ID!, $pr: ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { project: PROJECT_ID });

            const found = item.node.items.nodes.find(i => i.content?.id === prNodeId);

            if (!found) return;

            await github.graphql(`
              mutation($project: ID!, $item: ID!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $project,
                  itemId: $item,
                  fieldId: "Status",
                  value: { singleSelectOptionId: "done" }
                }) {
                  clientMutationId
                }
              }
            `, {
              project: PROJECT_ID,
              item: found.id
            });
