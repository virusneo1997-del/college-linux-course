#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑ‚ĞµĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ»Ğ»ĞµĞ´Ğ¶Ğ°

set -e

echo "ğŸš€ Starting College App Deployment..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed"
    exit 1
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose is not installed"
    exit 1
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑ‚Ğ¸ ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
if ! docker network ls | grep -q "college_network"; then
    echo "ğŸŒ Creating college_network..."
    docker network create college_network
fi

# Ğ—Ğ°Ğ¿ÑƒÑĞº/Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "ğŸ“¦ Building and starting services..."
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "â³ Waiting for services to start..."
sleep 30

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "ğŸ” Checking services health..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
if docker exec college_db pg_isready -U college_user -d college; then
    echo "âœ… Database is healthy"
else
    echo "âŒ Database health check failed"
    exit 1
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ĞµĞ±-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
if curl -f http://localhost/health &> /dev/null; then
    echo "âœ… Web application is healthy"
else
    echo "âŒ Web application health check failed"
    exit 1
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° nginx
if curl -f http://localhost &> /dev/null; then
    echo "âœ… Nginx is healthy"
else
    echo "âŒ Nginx health check failed"
    exit 1
fi

echo "ğŸ‰ Deployment completed successfully!"
echo "ğŸ“Š Application is available at: http://localhost"
echo "ğŸ‘¥ Students API: http://localhost/students"
echo "ğŸ“š Courses API: http://localhost/courses"

# ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°Ñ…
echo ""
echo "ğŸ“‹ Running containers:"
docker-compose ps